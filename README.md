# FlexERP
This project is a Web API built using **.NET 8**, designed for managing orders, discounts, and dynamic customer fields. The API includes the following features:

- **Order management with discounts**: View orders while applying discounts. Below you can see the class diagram:
  ![Class diagram](https://github.com/Predatoroid/orders-be/blob/main/Architecture/orders.drawio.png)
- **Dynamic customer fields**: Add custom fields to customer tabs, allowing dynamic field types like text boxes or dropdown options. Below you can see the database schema:
  ![Customer Fields Schema](https://github.com/Predatoroid/orders-be/blob/main/Architecture/schema.drawio.png)

## Technologies Used

- **.NET 8 (Minimal Web API)**: Framework used for building the API.
- **PostgreSQL**: Database for storing customer data and order information.
- **Graylog**: Log aggregation service to track and monitor application logs.
- **Serilog**: Structured logging for the application with output to Graylog.
- **Podman**: For containerizing the application and its dependencies, such as PostgreSQL and Graylog.
- **Dapper**: ORM used for interacting with the PostgreSQL database.

## Features

- **Order Discount Management**: Automatically apply discounts to orders and calculate final prices.
- **Dynamic Customer Fields**: Ability to create and update custom fields for customers.
- **Logging**: Logs are sent to Graylog for centralized log management.
- **Database**: PostgreSQL stores customer and order data, including history of field changes.

## Prerequisites

Before running the application, make sure you have the following installed:

- [.NET 8](https://dotnet.microsoft.com/en-us/download/dotnet/8.0) for running the backend application
- [Podman](https://podman.io/) for running the application and its dependencies in containers.
- [podman-compose](https://github.com/containers/podman-compose) to compose the containers together.

## Setting Up the Application

### 1. Clone the repository
```bash
git clone git@github.com:Predatoroid/orders-be.git
```

### 2. Podman Setup for Dependencies
Make sure you have Podman running and navigate to `Devops` folder. Use the following `podman-compose` command to bring up the necessary services (PostgreSQL, Graylog, etc.):
```bash
podman-compose -f podman-compose.yml up -d
```

This will start the following services:
- PostgreSQL (port 5432)
- MongoDB for Graylog (port 27017)
- Elasticsearch (port 9200)
- Graylog (port 9000)

### 3. Database Setup
Make sure your PostgreSQL instance has been initialized (`Database/schema.sql`) with the required schema by running any necessary SQL migration scripts. You can also configure this to run automatically through Podman with volumes.

### 4. Configure Graylog
- Open Graylog at http://127.0.0.1:9000/
- Login using the default username (`admin`) and password(`admin`) after following the initial setup steps.
- Create a new **Input** for receiving logs (e.g., GELF TCP/UDP on port `12201`).
- Once configured, Graylog will start receiving logs from your application.

### 5. Running the Backend Application
Now you can run your application in `FlexERP` folder:
```bash
dotnet run
```
Your Web API will be available at http://localhost:5086 (or whichever port you've configured in `launchSettings.json`).

### 6. Testing the Endpoints
You can now interact with the Web API through the following endpoints:

#### Orders
- **GET** `/api/orders/{orderId}` - Retrieve an order with applied discounts
#### Customers
- **POST** `/api/customers/{customerId}/fields` - Create a customer field.
- **GET** `/api/customers/{customerId}/fields/{fieldId}` - Retrieve a customer field.
- **GET** `/api/customers/{customerId}/fields/{fieldId}/history` - Retrieve all customer field history records.
- **POST** `/api/customers/{customerId}/fields/{fieldId}/options` - Create options for a field.
- **POST** `/api/customers/{customerId}/fields/{fieldId}/options/{optionId}/values` - Set values for a field option.
- **PATCH** `/api/customers/{customerId}/fields/{fieldId}` - Update a customer field.
- **PATCH** `/api/customers/{customerId}/fields/{fieldId}/options/{optionId}` - Update a customer field option.

### 7. Log Management in Graylog
All logs generated by the application will be sent to Graylog. You can search, filter, and analyze logs from within the Graylog UI.
![Graylog](https://github.com/Predatoroid/orders-be/blob/main/Architecture/graylog.png)

## Troubleshooting
- **Graylog Logs Not Appearing**: Ensure the Graylog input is configured correctly and the application is running with the correct log configuration.
- **PostgreSQL Connection Issues**: Check that the PostgreSQL container is running and accessible from the application.
- **API Errors**: Check the application logs in Graylog for detailed error messages.

## License
This project is licensed under the MIT License - see the [LICENSE](https://github.com/Predatoroid/orders-be/blob/main/LICENSE) file for details.